#define _GNU_SOURCE
#include <fcntl.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <unistd.h>

const char *readme = "/home/pwn/readme";
const char *tmp_readme = "/tmp/pwn/readme";

int main()
{
    if (unshare(CLONE_NEWUSER | CLONE_NEWNS))
    {
        perror("unshare");
        goto end;
    };

    int status = 1;
    int fd = -1;
    struct stat s = {0};

    if (-1 == mkdir("/tmp/pwn", O_RDWR))
    {
        perror("failed to create tmp dir:");
        goto end;
    }

    // if (-1 == mount("/home/pwn", "/tmp/pwn", NULL, MS_BIND, NULL))
    // {
    //     perror("failed to mount home to tmp:");

    //     goto end;
    // }

    // if (-1 == mount("/tmp/pwn", "/tmp/pwn", NULL, MS_REMOUNT | MS_NOSUID,
    // NULL))
    // {
    //     perror("failed to remount home:");

    //     goto end;
    // }

    if (-1 == stat(readme, &s))
    {
        perror("failed to stat file:");
        goto end;
    }
    printf("I-node number: %ju\n", (uintmax_t)s.st_ino);

    // symlink(readme, tmp_readme);

    // if (-1 == (fd = open(tmp_readme, O_RDONLY)))
    // {
    //     perror("failed to open file:");
    //     goto end;
    // }

    status = 0;

end:
    return status;
}